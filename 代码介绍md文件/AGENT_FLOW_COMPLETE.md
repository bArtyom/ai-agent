# Agent å®Œæ•´è°ƒç”¨æµç¨‹è¯¦è§£

## ğŸ¯ å¿«é€Ÿæ¦‚è§ˆ

ä»ç”¨æˆ·è°ƒç”¨å¼€å§‹åˆ°è·å¾— AI å“åº”çš„å®Œæ•´æµç¨‹ï¼š

```
ç”¨æˆ·æµ‹è¯•ä»£ç 
    â†“ (1. è·å– Bean)
Spring å®¹å™¨
    â†“ (2. æ³¨å…¥)
LoveApp å®ä¾‹
    â†“ (3. è°ƒç”¨æ–¹æ³•)
doChat(message, chatId)
    â†“ (4. åˆ›å»º)
ChatClient.prompt()
    â†“ (5. è®¾ç½®å‚æ•°)
.user(message)
    â†“ (6. åŠ è½½å†å²)
MessageChatMemoryAdvisor
    â†“ (7. æƒé™æ£€æŸ¥)
AuthCheckAdvisor
    â†“ (8. è°ƒç”¨)
LLM (DashScope/OpenAI)
    â†“ (9. è·å–å“åº”)
ChatResponse
    â†“ (10. è¿”å›)
String ç­”æ¡ˆ
```

---

## ğŸ“ è¯¦ç»†æ­¥éª¤è§£æ

### ç¬¬ 1 æ­¥ï¼šè·å– LoveApp Bean

```java
@SpringBootTest
class LoveAppTest {
    @Resource  // â† Spring ä¾èµ–æ³¨å…¥
    private LoveApp loveApp;
    
    @Test
    void testChat() {
        // è·å¾—äº† LoveApp å®ä¾‹
    }
}
```

**å‘ç”Ÿäº†ä»€ä¹ˆï¼š**
- Spring Boot å¯åŠ¨æ—¶æ‰«æ `@Component` æ³¨è§£
- æ‰¾åˆ° `LoveApp` ç±»
- è‡ªåŠ¨åˆ›å»ºå•ä¾‹ Bean å¹¶æ³¨å…¥åˆ°æµ‹è¯•ç±»ä¸­

---

### ç¬¬ 2 æ­¥ï¼šLoveApp åˆå§‹åŒ–

```java
@Component  // â† Spring ä¼šè‡ªåŠ¨åˆ›å»ºè¿™ä¸ªç±»çš„å®ä¾‹
@Slf4j
public class LoveApp {
    private final ChatClient chatClient;
    
    // Spring è‡ªåŠ¨è°ƒç”¨è¿™ä¸ªæ„é€ å‡½æ•°
    public LoveApp(ChatModel dashscopeChatModel) {
        // dashscopeChatModel ä¹Ÿæ˜¯ç”± Spring æ³¨å…¥çš„
        // å®ƒæ˜¯ DashScope/OpenAI çš„ ChatModel å®ç°
        
        // åˆå§‹åŒ–å¯¹è¯è®°å¿†
        ChatMemory chatMemory = new InMemoryChatMemory();
        
        // æ„å»º ChatClient
        chatClient = ChatClient.builder(dashscopeChatModel)
                .defaultSystem(SYSTEM_PROMPT)
                .defaultAdvisors(
                        new MessageChatMemoryAdvisor(chatMemory)
                )
                .build();
    }
}
```

**å…³é”®å¯¹è±¡ï¼š**
- `ChatModel` â† LLM çš„æ ¸å¿ƒæ¨¡å‹
- `ChatClient` â† å‘é€è¯·æ±‚çš„å®¢æˆ·ç«¯
- `ChatMemory` â† å­˜å‚¨å¯¹è¯å†å²
- `MessageChatMemoryAdvisor` â† ç®¡ç†å†å²æ¶ˆæ¯

---

### ç¬¬ 3 æ­¥ï¼šè°ƒç”¨ doChat æ–¹æ³•

```java
@Test
void testChat() {
    String chatId = UUID.randomUUID().toString();
    String message = "ä½ å¥½ï¼Œæˆ‘æ˜¯ç¨‹åºå‘˜é±¼çš®";
    
    String answer = loveApp.doChat(message, chatId);
    //  â†‘ è¿›å…¥è¿™ä¸ªæ–¹æ³•
}
```

---

### ç¬¬ 4 æ­¥ï¼šæ„å»º Prompt

```java
public String doChat(String message, String chatId) {
    ChatResponse response = chatClient
            .prompt()  // â† åˆ›å»º PromptBuilder
            .user(message)  // â† è®¾ç½®ç”¨æˆ·è¾“å…¥
            .advisors(spec -> 
                spec.param(CHAT_MEMORY_CONVERSATION_ID_KEY, chatId)
                    .param(CHAT_MEMORY_RETRIEVE_SIZE_KEY, 10)
            )  // â† é…ç½® Advisor å‚æ•°
            .call()  // â† æ‰§è¡ŒåŒæ­¥è°ƒç”¨
            .chatResponse();
    
    String content = response.getResult().getOutput().getText();
    return content;
}
```

**è¿™ä¸€æ­¥åˆ›å»ºçš„å¯¹è±¡ï¼š**
```
chatClient.prompt()
    â†“
PromptBuilder å¯¹è±¡ï¼ˆç”¨äºæ„å»ºè¯·æ±‚ï¼‰
```

---

### ç¬¬ 5 æ­¥ï¼šAdvisor é“¾å¼æ‰§è¡Œ

å½“ `.call()` æ‰§è¡Œæ—¶ï¼ŒAdvisor é“¾å¼è°ƒç”¨å¼€å§‹ï¼š

```
call() è§¦å‘
    â†“
æŸ¥çœ‹ defaultAdvisors åˆ—è¡¨ï¼š
    [MessageChatMemoryAdvisor, AuthCheckAdvisor(è‡ªå·±çš„)]
    â†“
æŒ‰ order æ’åºï¼ˆéƒ½æ˜¯ 0ï¼ŒæŒ‰æ³¨å†Œé¡ºåºï¼‰
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ MessageChatMemoryAdvisor        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â‘  ä» ChatMemory åŠ è½½å†å²æ¶ˆæ¯    â”‚
â”‚   key: chatId                   â”‚
â”‚   è·å–æœ€è¿‘ 10 æ¡æ¶ˆæ¯             â”‚
â”‚                                 â”‚
â”‚ â‘¡ chain.nextAroundCall()        â”‚
â”‚    â†“                            â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚    â”‚ AuthCheckAdvisor      â”‚   â”‚
â”‚    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚    â”‚ â‘  before()           â”‚   â”‚
â”‚    â”‚   - getUserId()      â”‚   â”‚
â”‚    â”‚   - checkPermission()â”‚   â”‚
â”‚    â”‚   - checkBanned()    â”‚   â”‚
â”‚    â”‚                       â”‚   â”‚
â”‚    â”‚ â‘¡ chain.next()      â”‚   â”‚
â”‚    â”‚    â†“ æ²¡æœ‰ä¸‹ä¸€ä¸ª       â”‚   â”‚
â”‚    â”‚    è°ƒç”¨ LLM           â”‚   â”‚
â”‚    â”‚                       â”‚   â”‚
â”‚    â”‚ â‘¢ return response    â”‚   â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚    â†‘                            â”‚
â”‚ â‘¢ å°† [å†å²æ¶ˆæ¯ + å½“å‰æ¶ˆæ¯] å‘é€  â”‚
â”‚    ç»™ LLMï¼Œè·å¾—å“åº”             â”‚
â”‚                                 â”‚
â”‚ â‘£ å°†å“åº”å­˜å…¥ ChatMemory         â”‚
â”‚    key: chatId                  â”‚
â”‚                                 â”‚
â”‚ â‘¤ return response               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
è¿”å›ç»™ç”¨æˆ·
```

---

### ç¬¬ 6 æ­¥ï¼šLLM å¤„ç†

```
LLM æ”¶åˆ°è¯·æ±‚ï¼š
â”œâ”€ System Prompt (ç³»ç»Ÿæç¤ºè¯)
â”‚  â””â”€ "æ‰®æ¼”æ·±è€•æ‹çˆ±å¿ƒç†é¢†åŸŸçš„ä¸“å®¶..."
â”‚
â”œâ”€ History Messages (å†å²æ¶ˆæ¯)
â”‚  â”œâ”€ User: "ä½ å¥½ï¼Œæˆ‘æ˜¯ç¨‹åºå‘˜é±¼çš®"
â”‚  â”œâ”€ Assistant: "å¾ˆé«˜å…´è®¤è¯†ä½ ..."
â”‚  â””â”€ ...
â”‚
â””â”€ Current Message (å½“å‰æ¶ˆæ¯)
   â””â”€ User: "æˆ‘æƒ³è®©å¦ä¸€åŠæ›´çˆ±æˆ‘"

LLM ç”Ÿæˆå“åº”
    â†“
"æˆ‘ç†è§£ä½ çš„æƒ³æ³•ï¼Œæ‹çˆ±ä¸­çš„äº²å¯†æ„Ÿå¾ˆé‡è¦...
 ä»ä»¥ä¸‹å‡ ä¸ªæ–¹é¢è€ƒè™‘..."
```

---

### ç¬¬ 7 æ­¥ï¼šå“åº”è¿”å›

```java
ChatResponse response = chatClient
        .prompt()
        .user(message)
        .advisors(...)
        .call()  // â† è°ƒç”¨å®Œæˆ
        .chatResponse();  // â† è·å–å“åº”å¯¹è±¡

String content = response
        .getResult()  // â† è·å–ç»“æœ
        .getOutput()  // â† è·å–è¾“å‡ºæ¶ˆæ¯
        .getText();   // â† è·å–æ–‡æœ¬å†…å®¹

return content;  // â† è¿”å›ç»™æµ‹è¯•ä»£ç 
```

---

## ğŸ”„ å®Œæ•´è°ƒç”¨é“¾æµç¨‹å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æµ‹è¯•ä»£ç ï¼ˆLoveAppTestï¼‰                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚ 1. @Resource æ³¨å…¥
                       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Spring å®¹å™¨                                                      â”‚
â”‚                                                                  â”‚
â”‚ â‘  æ£€æµ‹ @Component LoveApp                                       â”‚
â”‚ â‘¡ æ£€æµ‹æ„é€ å‡½æ•°å‚æ•° ChatModel                                    â”‚
â”‚ â‘¢ åˆ›å»º ChatModel Bean (DashScope å®ç°)                          â”‚
â”‚ â‘£ åˆ›å»º LoveApp å®ä¾‹                                             â”‚
â”‚ â‘¤ æ³¨å…¥ LoveApp åˆ°æµ‹è¯•ç±»                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚ 2. è°ƒç”¨æ–¹æ³•
                       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ loveApp.doChat(message, chatId)                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚ 3. åˆ›å»º PromptBuilder
                       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ChatClient.prompt()                                             â”‚
â”‚                                                                  â”‚
â”‚ â‘  .user(message)                                                â”‚
â”‚ â‘¡ .advisors(spec -> ...)                                        â”‚
â”‚ â‘¢ .call()  â† æ‰§è¡Œå…³é”®æ­¥éª¤                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚ 4. è§¦å‘ Advisor é“¾
                       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ MessageChatMemoryAdvisor                                        â”‚
â”‚                                                                  â”‚
â”‚ â‘  ä» ChatMemory åŠ è½½å†å²æ¶ˆæ¯                                    â”‚
â”‚    SELECT * WHERE chatId = "xxx" LIMIT 10                       â”‚
â”‚                                                                  â”‚
â”‚ â‘¡ chain.nextAroundCall(request)                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚ 5. é“¾å¼è°ƒç”¨ä¸‹ä¸€ä¸ª Advisor
                       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ AuthCheckAdvisor                                                â”‚
â”‚                                                                  â”‚
â”‚ â‘  before(request)                                               â”‚
â”‚    â”œâ”€ getUserId(context) â†’ "user123"                            â”‚
â”‚    â”œâ”€ checkPermission("user123")                                â”‚
â”‚    â”‚  â”œâ”€ if "banned-user" â†’ throw Exception âœ—                 â”‚
â”‚    â”‚  â”œâ”€ if guest-* ä¸”ä¸åœ¨ç™½åå• â†’ throw Exception âœ—          â”‚
â”‚    â”‚  â””â”€ å¦åˆ™ âœ“ é€šè¿‡                                            â”‚
â”‚    â”œâ”€ checkBannedWords(messages)                                â”‚
â”‚    â”‚  â””â”€ éå†æ‰€æœ‰æ¶ˆæ¯ï¼Œæ£€æŸ¥è¿ç¦è¯                              â”‚
â”‚    â””â”€ logAudit(userId, request) â†’ è®°å½•æ—¥å¿—                     â”‚
â”‚                                                                  â”‚
â”‚ â‘¡ chain.nextAroundCall(checkedRequest)                          â”‚
â”‚    â†’ æ²¡æœ‰ä¸‹ä¸€ä¸ª Advisorï¼Œè°ƒç”¨ LLM                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚ 6. è°ƒç”¨ LLM
                       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ChatModel (DashScope)                                           â”‚
â”‚                                                                  â”‚
â”‚ è¯·æ±‚å†…å®¹:                                                       â”‚
â”‚ â”œâ”€ System: "æ‰®æ¼”æ·±è€•æ‹çˆ±å¿ƒç†é¢†åŸŸçš„ä¸“å®¶..."                      â”‚
â”‚ â”œâ”€ History:                                                     â”‚
â”‚ â”‚  â”œâ”€ User: "ä½ å¥½ï¼Œæˆ‘æ˜¯ç¨‹åºå‘˜é±¼çš®"                              â”‚
â”‚ â”‚  â”œâ”€ Assistant: "å¾ˆé«˜å…´è®¤è¯†ä½ ..."                              â”‚
â”‚ â”‚  â””â”€ ...                                                       â”‚
â”‚ â””â”€ Current: "æˆ‘æƒ³è®©å¦ä¸€åŠæ›´çˆ±æˆ‘"                                â”‚
â”‚                                                                  â”‚
â”‚ â‘  å‘é€ HTTP è¯·æ±‚åˆ° DashScope API                               â”‚
â”‚ â‘¡ ç­‰å¾… LLM ç”Ÿæˆå“åº”                                             â”‚
â”‚ â‘¢ è§£æ JSON å“åº”                                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚ 7. è¿”å› ChatResponse
                       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ AuthCheckAdvisor.aroundCall() è¿”å›                              â”‚
â”‚                                                                  â”‚
â”‚ return chain.nextAroundCall(...)  â† AdvisedResponse             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ MessageChatMemoryAdvisor ç»§ç»­                                   â”‚
â”‚                                                                  â”‚
â”‚ â‘  å°†å“åº”å­˜å…¥ ChatMemory                                         â”‚
â”‚    INSERT INTO chatMemory                                       â”‚
â”‚    VALUE(chatId, [User msg, Assistant response])               â”‚
â”‚                                                                  â”‚
â”‚ â‘¡ return response                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ .chatResponse()                                                 â”‚
â”‚ è·å– ChatResponse å¯¹è±¡                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ response.getResult().getOutput().getText()                      â”‚
â”‚                                                                  â”‚
â”‚ â‘  response.getResult() â†’ Message å¯¹è±¡                           â”‚
â”‚ â‘¡ .getOutput() â†’ AssistantMessage                              â”‚
â”‚ â‘¢ .getText() â†’ String æ–‡æœ¬                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ return content;                                                 â”‚
â”‚                                                                  â”‚
â”‚ "æˆ‘ç†è§£ä½ çš„æƒ³æ³•ï¼Œæ‹çˆ±ä¸­äº²å¯†æ„Ÿå¾ˆé‡è¦..."                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â†‘
                       â”‚
                è¿”å›ç»™æµ‹è¯•ä»£ç 
```

---

## ğŸ”‘ å…³é”®ç±»å’Œæ–¹æ³•

| ç±» | æ–¹æ³• | ä½œç”¨ |
|-----|------|------|
| **ChatClient** | `prompt()` | åˆ›å»ºè¯·æ±‚æ„å»ºå™¨ |
| **ChatClient** | `.user(msg)` | è®¾ç½®ç”¨æˆ·æ¶ˆæ¯ |
| **ChatClient** | `.call()` | æ‰§è¡ŒåŒæ­¥è°ƒç”¨ |
| **ChatModel** | ç”± Spring è‡ªåŠ¨æ³¨å…¥ | è°ƒç”¨ LLM (DashScope) |
| **ChatMemory** | å­˜å‚¨å’Œè¯»å– | å†å²æ¶ˆæ¯å­˜å‚¨ |
| **Advisor** | `aroundCall()` | å‰ç½®/åç½®å¤„ç† |
| **AuthCheckAdvisor** | `before()` | æƒé™å’Œè¿ç¦è¯æ£€æŸ¥ |

---

## ğŸ¯ ä¸‰è½®å¯¹è¯çš„å®Œæ•´æµç¨‹

### ç¬¬ä¸€è½®

```
Input:  "ä½ å¥½ï¼Œæˆ‘æ˜¯ç¨‹åºå‘˜é±¼çš®"
ChatMemory: ç©º (æ— å†å²)

Prompt å‘é€ç»™ LLM:
  System: "æ‰®æ¼”æ‹çˆ±å¿ƒç†ä¸“å®¶..."
  History: []
  Current: "ä½ å¥½ï¼Œæˆ‘æ˜¯ç¨‹åºå‘˜é±¼çš®"

Output: "å¾ˆé«˜å…´è®¤è¯†ä½ ï¼æˆ‘æ˜¯æ‹çˆ±å¿ƒç†å’¨è¯¢å¸ˆ..."

ChatMemory ä¿å­˜:
  chatId â†’ [
    {role: user, content: "ä½ å¥½ï¼Œæˆ‘æ˜¯ç¨‹åºå‘˜é±¼çš®"},
    {role: assistant, content: "å¾ˆé«˜å…´è®¤è¯†ä½ ï¼..."}
  ]
```

### ç¬¬äºŒè½®

```
Input:  "æˆ‘æƒ³è®©å¦ä¸€åŠæ›´çˆ±æˆ‘"
ChatMemory: å·²æœ‰ç¬¬ä¸€è½®çš„æ¶ˆæ¯

Prompt å‘é€ç»™ LLM:
  System: "æ‰®æ¼”æ‹çˆ±å¿ƒç†ä¸“å®¶..."
  History: [
    {user: "ä½ å¥½ï¼Œæˆ‘æ˜¯ç¨‹åºå‘˜é±¼çš®"},
    {assistant: "å¾ˆé«˜å…´è®¤è¯†ä½ ï¼..."}
  ]
  Current: "æˆ‘æƒ³è®©å¦ä¸€åŠæ›´çˆ±æˆ‘"

Output: "æˆ‘ç†è§£ä½ çš„æƒ³æ³•ã€‚å»ºç«‹äº²å¯†å…³ç³»éœ€è¦ä»å‡ ä¸ªæ–¹é¢è€ƒè™‘..."

ChatMemory æ›´æ–°:
  chatId â†’ [
    {user: "ä½ å¥½ï¼Œæˆ‘æ˜¯ç¨‹åºå‘˜é±¼çš®"},
    {assistant: "å¾ˆé«˜å…´è®¤è¯†ä½ ï¼..."},
    {user: "æˆ‘æƒ³è®©å¦ä¸€åŠæ›´çˆ±æˆ‘"},
    {assistant: "æˆ‘ç†è§£ä½ çš„æƒ³æ³•ã€‚..."}
  ]
```

### ç¬¬ä¸‰è½®

```
Input:  "æˆ‘çš„å¦ä¸€åŠå«ä»€ä¹ˆæ¥ç€ï¼Ÿåˆšè·Ÿä½ è¯´è¿‡"
ChatMemory: å·²æœ‰å‰ä¸¤è½®çš„æ¶ˆæ¯

Prompt å‘é€ç»™ LLM:
  System: "æ‰®æ¼”æ‹çˆ±å¿ƒç†ä¸“å®¶..."
  History: [
    {user: "ä½ å¥½ï¼Œæˆ‘æ˜¯ç¨‹åºå‘˜é±¼çš®"},
    {assistant: "å¾ˆé«˜å…´è®¤è¯†ä½ ï¼..."},
    {user: "æˆ‘æƒ³è®©å¦ä¸€åŠæ›´çˆ±æˆ‘"},
    {assistant: "æˆ‘ç†è§£ä½ çš„æƒ³æ³•ã€‚..."}
  ]
  Current: "æˆ‘çš„å¦ä¸€åŠå«ä»€ä¹ˆæ¥ç€ï¼Ÿåˆšè·Ÿä½ è¯´è¿‡"

LLM ä»å†å²ä¸­æ‰¾åˆ°: "ä½ è¯´ä½ çš„å¦ä¸€åŠæ˜¯ç¼–ç¨‹å¯¼èˆª"

Output: "ä½ è¯´ä½ çš„å¦ä¸€åŠæ˜¯ç¼–ç¨‹å¯¼èˆªã€‚è®©æˆ‘ç»§ç»­å¸®ä½ ..."
```

---

## ğŸ“Š å¯¹è±¡åˆ›å»ºé¡ºåº

```
1ï¸âƒ£ ChatModel
   â†“ (ç”± Spring Boot è‡ªåŠ¨è£…é…)
2ï¸âƒ£ LoveApp.constructor(ChatModel)
   â”œâ”€ ChatMemory
   â”œâ”€ ChatClient.builder(ChatModel)
   â”œâ”€ .defaultAdvisors([MessageChatMemoryAdvisor])
   â””â”€ .build()
3ï¸âƒ£ LoveApp å•ä¾‹ Bean
   â†“ (æ³¨å…¥åˆ°æµ‹è¯•ç±»)
4ï¸âƒ£ LoveAppTest.loveApp
   â†“ (è°ƒç”¨)
5ï¸âƒ£ loveApp.doChat(message, chatId)
   â”œâ”€ ChatClient.prompt()
   â”œâ”€ PromptBuilder
   â””â”€ Advisor é“¾æ‰§è¡Œ
```

---

## âœ… æ€»ç»“

| é˜¶æ®µ | å…³é”®æ­¥éª¤ |
|------|---------|
| **åˆå§‹åŒ–** | Spring åˆ›å»º ChatModel â†’ åˆ›å»º LoveApp |
| **è¯·æ±‚æ„å»º** | ChatClient.prompt().user(msg).advisors(...) |
| **å‰ç½®å¤„ç†** | MessageChatMemoryAdvisor åŠ è½½å†å² |
| **å®‰å…¨æ£€æŸ¥** | AuthCheckAdvisor æ£€æŸ¥æƒé™å’Œè¿ç¦è¯ |
| **LLM è°ƒç”¨** | ChatModel è°ƒç”¨ DashScope API |
| **åç½®å¤„ç†** | MessageChatMemoryAdvisor ä¿å­˜æ¶ˆæ¯ |
| **å“åº”å¤„ç†** | æå–æ–‡æœ¬å†…å®¹ï¼Œè¿”å›ç»™ç”¨æˆ· |


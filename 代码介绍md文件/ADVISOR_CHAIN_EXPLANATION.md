# AuthCheckAdvisor è°ƒç”¨é“¾è¯¦ç»†è¯´æ˜

## ğŸ“š æ ¸å¿ƒæ¦‚å¿µ

### ä»€ä¹ˆæ˜¯ `chain.nextAroundCall()` å’Œ `chain.nextAroundStream()`ï¼Ÿ

è¿™ä¸¤ä¸ªæ–¹æ³•æ˜¯**é“¾å¼è°ƒç”¨**çš„å…³é”®ã€‚å®ƒä»¬è´Ÿè´£å°†è¯·æ±‚ä¼ é€’ç»™ä¸‹ä¸€ä¸ª Advisor æˆ–æœ€ç»ˆçš„ LLMã€‚

```
chain.nextAroundCall(checkedRequest)
     â†“
æŒ‰ç…§ Order ä¼˜å…ˆçº§ä¾æ¬¡è°ƒç”¨ï¼š
  â‘  ä¸‹ä¸€ä¸ª Advisor (if exists)
  â‘¡ æˆ–è€…ç›´æ¥è°ƒç”¨ LLM (if è¿™æ˜¯æœ€åä¸€ä¸ª Advisor)
```

---

## ğŸ”— å•ä¸ª Advisor çš„è°ƒç”¨æµç¨‹

### ç¤ºä¾‹ï¼šåªæœ‰ AuthCheckAdvisor

```
ç”¨æˆ·ä»£ç 
  â†“
chatClient.prompt().user("ä½ å¥½").call()
  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ AuthCheckAdvisor.aroundCall()            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                         â”‚
â”‚  1ï¸âƒ£ before(advisedRequest)              â”‚
â”‚     â”œâ”€ getUserId()                      â”‚
â”‚     â”œâ”€ checkPermission()  â† æ£€æŸ¥æƒé™    â”‚
â”‚     â”œâ”€ checkBannedWords() â† æ£€æŸ¥è¿ç¦è¯  â”‚
â”‚     â””â”€ logAudit()         â† è®°å½•æ—¥å¿—    â”‚
â”‚                                         â”‚
â”‚  âœ… æ£€æŸ¥é€šè¿‡ï¼ˆæ²¡æœ‰å¼‚å¸¸ï¼‰                 â”‚
â”‚                                         â”‚
â”‚  2ï¸âƒ£ chain.nextAroundCall(checkedRequest)â”‚
â”‚     â†“                                   â”‚
â”‚     ç”±äºæ²¡æœ‰ä¸‹ä¸€ä¸ª Advisor              â”‚
â”‚     â†“                                   â”‚
â”‚     ç›´æ¥è°ƒç”¨ LLM                        â”‚
â”‚     â†“                                   â”‚
â”‚  3ï¸âƒ£ LLM è¿”å› AdvisedResponse            â”‚
â”‚                                         â”‚
â”‚  4ï¸âƒ£ æ—¥å¿—: "åŒæ­¥è°ƒç”¨å®Œæˆ"                â”‚
â”‚                                         â”‚
â”‚  5ï¸âƒ£ return response                     â”‚
â”‚                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â†“
è¿”å›ç»™ç”¨æˆ·
```

### ä»£ç å¯¹åº”å…³ç³»

```java
@Override
public AdvisedResponse aroundCall(AdvisedRequest advisedRequest, CallAroundAdvisorChain chain) {
    // â‘  å‰ç½®å¤„ç†
    AdvisedRequest checkedRequest = this.before(advisedRequest);
    // â‘¡ ç»§ç»­é“¾å¼è°ƒç”¨ï¼Œä¼ é€’ç»™ä¸‹ä¸€ä¸ªï¼ˆæˆ–LLMï¼‰
    AdvisedResponse response = chain.nextAroundCall(checkedRequest);
    // â‘¢ åç½®å¤„ç†
    log.debug("{}ï¼šåŒæ­¥è°ƒç”¨å®Œæˆ", this.getName());
    // â‘£ è¿”å›
    return response;
}
```

---

## â›“ï¸ å¤šä¸ª Advisor çš„è°ƒç”¨é“¾

### åœºæ™¯ï¼šæœ‰ 3 ä¸ª Advisor

```java
.defaultAdvisors(
    new AuthCheckAdvisor(),      // order = 0
    new MyLoggerAdvisor(),       // order = 0ï¼ˆç›¸åŒorderï¼‰
    new ReReadingAdvisor()       // order = 0ï¼ˆç›¸åŒorderï¼‰
)
```

### å®Œæ•´è°ƒç”¨é“¾æµç¨‹

```
ç”¨æˆ·ä»£ç ï¼šchatClient.prompt().user("ä½ å¥½").call()
  â†“
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘ AuthCheckAdvisor.aroundCall() ã€ç¬¬1ä¸ª Advisorã€‘              â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘                                                               â•‘
â•‘ â‘  before(advisedRequest)                                     â•‘
â•‘    â”œâ”€ getUserId()                                            â•‘
â•‘    â”œâ”€ checkPermission()  â† âœ… æ£€æŸ¥é€šè¿‡                        â•‘
â•‘    â”œâ”€ checkBannedWords() â† âœ… æ£€æŸ¥é€šè¿‡                        â•‘
â•‘    â””â”€ logAudit()                                             â•‘
â•‘                                                               â•‘
â•‘ â‘¡ chain.nextAroundCall(checkedRequest)                       â•‘
â•‘    â†“â†“â†“ å…³é”®ï¼å°†è¯·æ±‚ä¼ ç»™ä¸‹ä¸€ä¸ª Advisor â†“â†“â†“                     â•‘
â•‘                                                               â•‘
â•‘    â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•— â•‘
â•‘    â•‘ MyLoggerAdvisor.aroundCall() ã€ç¬¬2ä¸ª Advisorã€‘        â•‘ â•‘
â•‘    â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£ â•‘
â•‘    â•‘                                                       â•‘ â•‘
â•‘    â•‘ â‘  before(advisedRequest)                             â•‘ â•‘
â•‘    â•‘    â””â”€ è®°å½•æ—¥å¿—                                        â•‘ â•‘
â•‘    â•‘                                                       â•‘ â•‘
â•‘    â•‘ â‘¡ chain.nextAroundCall(checkedRequest)               â•‘ â•‘
â•‘    â•‘    â†“â†“â†“ ç»§ç»­ä¼ ç»™ä¸‹ä¸€ä¸ª Advisor â†“â†“â†“                     â•‘ â•‘
â•‘    â•‘                                                       â•‘ â•‘
â•‘    â•‘    â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•— â•‘ â•‘
â•‘    â•‘    â•‘ ReReadingAdvisor.aroundCall()ã€ç¬¬3ä¸ªã€‘        â•‘ â•‘ â•‘
â•‘    â•‘    â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£ â•‘ â•‘
â•‘    â•‘    â•‘                                               â•‘ â•‘ â•‘
â•‘    â•‘    â•‘ â‘  before(advisedRequest)                     â•‘ â•‘ â•‘
â•‘    â•‘    â•‘    â””â”€ é‡æ–°è¯»å–æ•°æ®                            â•‘ â•‘ â•‘
â•‘    â•‘    â•‘                                               â•‘ â•‘ â•‘
â•‘    â•‘    â•‘ â‘¡ chain.nextAroundCall(checkedRequest)       â•‘ â•‘ â•‘
â•‘    â•‘    â•‘    â†“â†“â†“ æ²¡æœ‰ä¸‹ä¸€ä¸ª Advisor äº†ï¼â†“â†“â†“             â•‘ â•‘ â•‘
â•‘    â•‘    â•‘    ç›´æ¥è°ƒç”¨ LLM                               â•‘ â•‘ â•‘
â•‘    â•‘    â•‘                                               â•‘ â•‘ â•‘
â•‘    â•‘    â•‘    â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—   â•‘ â•‘ â•‘
â•‘    â•‘    â•‘    â•‘ LLM å¤„ç†å¹¶è¿”å› AdvisedResponse      â•‘   â•‘ â•‘ â•‘
â•‘    â•‘    â•‘    â•‘ "ä½ å¥½ï¼æˆ‘æ˜¯AIåŠ©æ‰‹"                   â•‘   â•‘ â•‘ â•‘
â•‘    â•‘    â•‘    â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•   â•‘ â•‘ â•‘
â•‘    â•‘    â•‘                                               â•‘ â•‘ â•‘
â•‘    â•‘    â•‘ â‘¢ è¿”å›å“åº”                                    â•‘ â•‘ â•‘
â•‘    â•‘    â•‘                                               â•‘ â•‘ â•‘
â•‘    â•‘    â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• â•‘ â•‘
â•‘    â•‘     (è¿”å›ç»™ MyLoggerAdvisor)                        â•‘ â•‘
â•‘    â•‘                                                       â•‘ â•‘
â•‘    â•‘ â‘¢ åç½®å¤„ç†                                           â•‘ â•‘
â•‘    â•‘    â””â”€ è®°å½•å“åº”                                       â•‘ â•‘
â•‘    â•‘                                                       â•‘ â•‘
â•‘    â•‘ â‘£ è¿”å›å“åº”                                           â•‘ â•‘
â•‘    â•‘                                                       â•‘ â•‘
â•‘    â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• â•‘
â•‘     (è¿”å›ç»™ AuthCheckAdvisor)                              â•‘
â•‘                                                               â•‘
â•‘ â‘¢ åç½®å¤„ç†                                                   â•‘
â•‘    â””â”€ æ—¥å¿—: "åŒæ­¥è°ƒç”¨å®Œæˆ"                                   â•‘
â•‘                                                               â•‘
â•‘ â‘£ è¿”å›å“åº”                                                   â•‘
â•‘                                                               â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  â†“
è¿”å›ç»™ç”¨æˆ·
```

### ç®€åŒ–æ—¶åºå›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Request é˜¶æ®µï¼ˆä»ä¸Šå¾€ä¸‹ï¼‰                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ AuthCheckAdvisor.before()  â† æƒé™æ£€æŸ¥                        â”‚
â”‚         â†“                                                    â”‚
â”‚ MyLoggerAdvisor.before()   â† æ—¥å¿—è®°å½•                        â”‚
â”‚         â†“                                                    â”‚
â”‚ ReReadingAdvisor.before()  â† é‡æ–°è¯»å–                        â”‚
â”‚         â†“                                                    â”‚
â”‚ LLM.call()                 â† è°ƒç”¨å¤§æ¨¡å‹                      â”‚
â”‚         â†“                                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Response é˜¶æ®µï¼ˆä»ä¸‹å¾€ä¸Šï¼‰                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ReReadingAdvisor.after()   â† å“åº”åå¤„ç†                      â”‚
â”‚         â†‘                                                    â”‚
â”‚ MyLoggerAdvisor.after()    â† å“åº”åå¤„ç†                      â”‚
â”‚         â†‘                                                    â”‚
â”‚ AuthCheckAdvisor.after()   â† å“åº”åå¤„ç†                      â”‚
â”‚         â†‘                                                    â”‚
â”‚ Return to User             â† è¿”å›ç»™ç”¨æˆ·                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”„ chain å¯¹è±¡çš„ä½œç”¨

### ä»€ä¹ˆæ˜¯ `CallAroundAdvisorChain`ï¼Ÿ

å®ƒæ˜¯ä¸€ä¸ª**é“¾å¼å®¹å™¨**ï¼ŒåŒ…å«ï¼š
- âœ… æ‰€æœ‰å‰©ä½™çš„ Advisor åˆ—è¡¨ï¼ˆæŒ‰ order æ’åºï¼‰
- âœ… æœ€ç»ˆçš„ LLM è°ƒç”¨

### `chain.nextAroundCall(request)` çš„å†…éƒ¨é€»è¾‘

```java
// ä¼ªä»£ç ï¼Œå±•ç¤º Spring AI æ¡†æ¶å†…éƒ¨å¦‚ä½•å®ç° chain

public class AdvisorChainImpl implements CallAroundAdvisorChain {
    
    private List<CallAroundAdvisor> remainingAdvisors;  // å‰©ä½™çš„ Advisor
    private ChatModel chatModel;                        // æœ€ç»ˆçš„ LLM
    
    @Override
    public AdvisedResponse nextAroundCall(AdvisedRequest request) {
        
        // â‘  å¦‚æœè¿˜æœ‰å‰©ä½™çš„ Advisor
        if (!remainingAdvisors.isEmpty()) {
            // è·å–ä¸‹ä¸€ä¸ª Advisor
            CallAroundAdvisor nextAdvisor = remainingAdvisors.remove(0);
            
            // ä¸ºä¸‹ä¸€ä¸ª Advisor åˆ›å»ºæ–°çš„ chainï¼ˆåŒ…å«æ›´å¤šå‰©ä½™çš„ Advisorï¼‰
            CallAroundAdvisorChain nextChain = new AdvisorChainImpl(
                remainingAdvisors,
                chatModel
            );
            
            // è°ƒç”¨ä¸‹ä¸€ä¸ª Advisor çš„ aroundCall æ–¹æ³•
            return nextAdvisor.aroundCall(request, nextChain);
        }
        
        // â‘¡ å¦‚æœæ²¡æœ‰å‰©ä½™çš„ Advisor äº†ï¼Œè°ƒç”¨ LLM
        else {
            Prompt prompt = request.toPrompt();
            return chatModel.call(prompt);
        }
    }
}
```

### å®é™…æ‰§è¡Œæ­¥éª¤

```
åˆå§‹çŠ¶æ€ï¼š
  chain.remainingAdvisors = [MyLoggerAdvisor, ReReadingAdvisor]
  chain.chatModel = OpenAiChatModel

ç¬¬1æ¬¡è°ƒç”¨ chain.nextAroundCall()ï¼š
  â”œâ”€ if (remainingAdvisors ä¸ä¸ºç©º) â†’ true
  â”œâ”€ nextAdvisor = MyLoggerAdvisor
  â”œâ”€ remainingAdvisors = [ReReadingAdvisor]  â† ç§»é™¤ MyLoggerAdvisor
  â”œâ”€ åˆ›å»ºæ–° chainï¼ŒåŒ…å« [ReReadingAdvisor]
  â””â”€ return MyLoggerAdvisor.aroundCall(request, æ–°chain)
  
MyLoggerAdvisor å†…éƒ¨è°ƒç”¨ chain.nextAroundCall()ï¼š
  â”œâ”€ if (remainingAdvisors ä¸ä¸ºç©º) â†’ true
  â”œâ”€ nextAdvisor = ReReadingAdvisor
  â”œâ”€ remainingAdvisors = []  â† ç§»é™¤ ReReadingAdvisor
  â”œâ”€ åˆ›å»ºæ–° chainï¼ŒåŒ…å« []
  â””â”€ return ReReadingAdvisor.aroundCall(request, æ–°chain)
  
ReReadingAdvisor å†…éƒ¨è°ƒç”¨ chain.nextAroundCall()ï¼š
  â”œâ”€ if (remainingAdvisors ä¸ä¸ºç©º) â†’ false
  â”œâ”€ remainingAdvisors å·²ä¸ºç©º
  â””â”€ return chatModel.call(prompt)  â† è°ƒç”¨ LLM
```

---

## ğŸš« å¼‚å¸¸å¤„ç†åœ¨é“¾ä¸­çš„ä¼ æ’­

### åœºæ™¯ï¼šæƒé™æ£€æŸ¥å¤±è´¥

```
User Request
  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ AuthCheckAdvisor.aroundCall()   â”‚
â”‚                                 â”‚
â”‚ â‘  before() è°ƒç”¨ checkPermission()
â”‚ â‘¡ checkPermission() æŠ›å‡ºå¼‚å¸¸:   â”‚
â”‚    SecurityException("å°ç¦ç”¨æˆ·") â”‚
â”‚                                 â”‚
â”‚ âŒ å¼‚å¸¸è¢«æŠ›å‡º                    â”‚
â”‚                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â†“
âŒ é“¾å¼è°ƒç”¨ä¸­æ–­ï¼
âŒ ä¸ä¼šè°ƒç”¨ chain.nextAroundCall()
âŒ ç›´æ¥è¿”å›å¼‚å¸¸ç»™ç”¨æˆ·
âŒ LLM æ°¸è¿œä¸ä¼šè¢«è°ƒç”¨
```

### å¯¹æ¯”ï¼šæ£€æŸ¥é€šè¿‡æ—¶

```
User Request
  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ AuthCheckAdvisor.aroundCall()   â”‚
â”‚                                 â”‚
â”‚ â‘  before() æ‰§è¡ŒæˆåŠŸ âœ…           â”‚
â”‚ â‘¡ checkPermission() æ£€æŸ¥é€šè¿‡ âœ…  â”‚
â”‚ â‘¢ checkBannedWords() æ£€æŸ¥é€šè¿‡ âœ…â”‚
â”‚                                 â”‚
â”‚ âœ… æ²¡æœ‰å¼‚å¸¸                      â”‚
â”‚ â‘£ chain.nextAroundCall()        â”‚
â”‚    â†“ ç»§ç»­é“¾å¼è°ƒç”¨ âœ…             â”‚
â”‚                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ MyLoggerAdvisor.aroundCall()    â”‚
â”‚ ... (ç»§ç»­é“¾å¼è°ƒç”¨)               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â†“
... (LLM)
```

---

## ğŸ“Š å¯¹æ¯”åŒæ­¥å’Œæµå¼

### åŒæ­¥ - aroundCall()

```java
public AdvisedResponse aroundCall(AdvisedRequest req, CallAroundAdvisorChain chain) {
    before(req);                         // å‰ç½®æ£€æŸ¥
    AdvisedResponse response = 
        chain.nextAroundCall(req);       // â³ é˜»å¡ç­‰å¾…å“åº”
    return response;                     // ä¸€æ¬¡æ€§è¿”å›
}
```

**ç‰¹ç‚¹ï¼š** ç­‰å¾…å®Œæ•´å“åº”åå†è¿”å›

### æµå¼ - aroundStream()

```java
public Flux<AdvisedResponse> aroundStream(AdvisedRequest req, StreamAroundAdvisorChain chain) {
    before(req);                         // å‰ç½®æ£€æŸ¥
    return chain.nextAroundStream(req)   // ç«‹å³è¿”å› Flux
            .doOnNext(response -> {      // æ¯ä¸ªå“åº”åˆ°è¾¾æ—¶
                // å¤„ç†æ¯ä¸ªå“åº”ç‰‡æ®µ
            });
}
```

**ç‰¹ç‚¹ï¼š** ç«‹å³è¿”å› Fluxï¼Œå“åº”é€ä¸ªå¤„ç†

---

## ğŸ’¡ ç†è§£å…³é”®

### â— æœ€é‡è¦çš„ç†è§£ç‚¹

```
chain.nextAroundCall() 
  = 
"å˜¿ï¼ä¸‹ä¸€ä¸ª Advisorï¼Œè½®åˆ°ä½ äº†ï¼
  æ‹¿ç€è¿™ä¸ªè¯·æ±‚ï¼Œåšå®Œä½ çš„å‰ç½®å¤„ç†ï¼Œ
  ç„¶åç»§ç»­ä¼ ç»™æ›´ä¸‹é¢çš„ Advisorã€‚
  å¤„ç†å®ŒåæŠŠå“åº”è¿”å›ç»™æˆ‘ã€‚"
```

### ğŸ¯ æ ¸å¿ƒæµç¨‹

1. **å½“å‰ Advisor åšå‰ç½®æ£€æŸ¥**
   ```
   checkPermission()  âœ… æ£€æŸ¥é€šè¿‡
   checkBannedWords() âœ… æ£€æŸ¥é€šè¿‡
   ```

2. **ä¼ ç»™ä¸‹ä¸€ä¸ªå¤„ç†è€…**
   ```
   chain.nextAroundCall(request)
   ```

3. **ä¸‹ä¸€ä¸ªå¤„ç†è€…ä¹ŸåšåŒæ ·çš„äº‹**
   ```
   æœ€åä¸€ä¸ª Advisor è°ƒç”¨ chain.nextAroundCall()
     â†“
   æ²¡æœ‰æ›´å¤š Advisor äº†
     â†“
   è°ƒç”¨ LLM
   ```

4. **å“åº”å±‚å±‚è¿”å›**
   ```
   LLM â†’ ReReadingAdvisor â†’ MyLoggerAdvisor â†’ AuthCheckAdvisor â†’ User
   ```

---

## ğŸ” å®é™…ä»£ç å¯¹åº”

### ä½ çš„ AuthCheckAdvisor

```java
@Override
public AdvisedResponse aroundCall(AdvisedRequest advisedRequest, CallAroundAdvisorChain chain) {
    // â‘  å‰ç½®æ£€æŸ¥
    AdvisedRequest checkedRequest = this.before(advisedRequest);
    // è¿™é‡Œæ‰§è¡Œï¼š
    //   - getUserId() è·å–ç”¨æˆ·ID
    //   - checkPermission() æ£€æŸ¥æ˜¯å¦è¢«å°ç¦
    //   - checkBannedWords() æ£€æŸ¥è¿ç¦è¯
    //   - logAudit() è®°å½•æ—¥å¿—
    
    // â‘¡ ç»§ç»­é“¾å¼è°ƒç”¨
    AdvisedResponse response = chain.nextAroundCall(checkedRequest);
    // è¿™è¡Œä»£ç ä¼šï¼š
    //   - å¦‚æœè¿˜æœ‰ä¸‹ä¸€ä¸ª Advisorï¼Œè°ƒç”¨å®ƒçš„ aroundCall()
    //   - å¦‚æœæ²¡æœ‰äº†ï¼Œç›´æ¥è°ƒç”¨ LLM
    //   - ç­‰å¾…å“åº”è¿”å›
    
    // â‘¢ åç½®å¤„ç†ï¼ˆå¯é€‰ï¼‰
    log.debug("{}ï¼šåŒæ­¥è°ƒç”¨å®Œæˆ", this.getName());
    
    // â‘£ è¿”å›å“åº”
    return response;
}
```

---

## ğŸ“Œ æ€»ç»“

| å†…å®¹ | è¯´æ˜ |
|------|------|
| **before()** | å‰ç½®æ£€æŸ¥ï¼ˆæƒé™ã€è¿ç¦è¯ç­‰ï¼‰|
| **chain.nextAroundCall()** | ä¼ ç»™ä¸‹ä¸€ä¸ª Advisor æˆ– LLM |
| **å“åº”å¤„ç†** | LLM è¿”å›å“åº”åçš„å¤„ç† |
| **å¼‚å¸¸ä¼ æ’­** | å‰ç½®æ£€æŸ¥å¤±è´¥åˆ™é“¾å¼è°ƒç”¨ä¸­æ–­ |
| **å¤š Advisor** | æŒ‰ order é¡ºåºä¾æ¬¡è°ƒç”¨ |
| **æµå¼ vs åŒæ­¥** | æµå¼ç”¨ Fluxï¼ŒåŒæ­¥ç›´æ¥è¿”å› |

